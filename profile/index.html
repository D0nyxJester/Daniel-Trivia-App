<!DOCTYPE html>
<html>

<head>
    <title>Profile Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f6fa;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 600px;
            margin: 40px auto;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 32px 24px 24px 24px;
        }
        h1 {
            color: #2c3e50;
            font-size: 1.5em;
            margin-bottom: 18px;
        }
        .trivia-title {
            color: #8e44ad;
            font-size: 2em;
            text-align: center;
            margin-bottom: 24px;
            font-weight: bold;
            letter-spacing: 1px;
        }
        title {
            text-align: center;
            font-size: 2em;
            margin-bottom: 24px;
            color: #34495e;
        }
        form {
            margin-bottom: 18px;
        }
        label {
            display: block;
            margin: 12px 0 4px 0;
            color: #34495e;
        }
        input, select {
            width: 100%;
            padding: 8px;
            margin-bottom: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background: #3498db;
            color: #fff;
            border: none;
            padding: 10px 18px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 8px;
        }
        button:hover {
            background: #2980b9;
        }
        pre#result {
            background: #f8f8f8;
            border-radius: 4px;
            padding: 12px;
            font-size: 0.95em;
            color: #333;
            max-height: 300px;
            overflow: auto;
        }
        table {
            width: 100%;
            margin-top: 16px;
            border-collapse: collapse;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        table.compact-table {
            width: 100%;
            font-size: 1em;
        }
        .compact-table th, .compact-table td {
            padding: 12px 14px;
            border-bottom: 1px solid #e0e0e0;
            text-align: left;
            word-break: break-word;
            white-space: normal;
        }
        .compact-table th {
            background-color: #f7f7f7;
            font-weight: 600;
        }
        .compact-table td {
            vertical-align: top;
            white-space: normal;   /* allows wrapping */
            word-wrap: break-word; /* breaks long words if needed */
            max-width: 400px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 id="welcome">Hello, and welcome to your profile!</h1>
        <h1 class="trivia-title" title="Get Random Trivia Questions">Get Random Trivia Questions</h1>
        <form id="triviaForm">
            <label for="amount">Number of questions:</label>
            <input type="number" id="amount" name="amount" value="5" min="1" max="50">
            <label for="category">Category:</label>
            <select id="category" name="category"> 
                <option value="9">General Knowledge</option>
                <option value="10">Entertainment: Books</option>
                <option value="11">Entertainment: Film</option>
                <option value="12">Entertainment: Music</option>
                <option value="13">Entertainment: Musicals &amp; Theatres</option>
                <option value="14">Entertainment: Television</option>
                <option value="15">Entertainment: Video Games</option>
                <option value="16">Entertainment: Board Games</option>
                <option value="17">Science &amp; Nature</option>
                <option value="18">Science: Computers</option>
                <option value="19">Science: Mathematics</option>
                <option value="20">Mythology</option>
                <option value="21">Sports</option>
                <option value="22">Geography</option>
                <option value="23">History</option>
                <option value="24">Politics</option>
                <option value="25">Art</option>
                <option value="26">Celebrities</option>
                <option value="27">Animals</option>
                <option value="28">Vehicles</option>
                <option value="29">Entertainment: Comics</option>
                <option value="30">Science: Gadgets</option>
                <option value="31">Entertainment: Japanese Anime &amp; Manga</option>
                <option value="32">Entertainment: Cartoon &amp; Animations</option> 
            </select>
            <label for="difficulty">Difficulty:</label>
            <select id="difficulty" name="difficulty">
                <option value="any">Any Difficulty</option>
                <option value="easy">Easy</option>
                <option value="medium">Medium</option>
                <option value="hard">Hard</option>
            </select>
            <label for="type">Type:</label> 
            <select id="type" name="type">
                <option value="any">Any Type</option>
                <option value="multiple">Multiple Choice</option>
                <option value="boolean">True / False</option>
            </select>
            <button type="submit">Get Trivia</button>
        </form>
        <pre id="result"></pre>
    </div>
    <div style="max-width: 1400px; margin: 40px auto; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 32px 24px 24px 24px;">   
        <h2>Your Trivia Results</h2>
        <div id="mytriviaResults"></div> 
    </div>
    <script>
        fetch('/api/user')
            .then(res => res.json())
            .then(data => {
                document.getElementById('welcome').textContent =
                    `Hello ${data.displayName}, and welcome to your profile!`;
            });
        // Fetch and display user's trivia history
        fetch('/api/my-trivia-results')
            .then(res => res.json())
            .then(results => {
                const triviaResults = document.getElementById('triviaResults');
                if (results.length === 0) {
                    mytriviaResults.textContent = 'No trivia results yet.';
                } else {
                    let tableHtml = '<table class="compact-table"><thead><tr><th>Question</th><th>Your Answer</th><th>Correct</th><th>Correct Answer</th><th>Date</th></tr></thead><tbody>';
                    results.forEach(r => {
                        tableHtml += `<tr>
                          <td>${r.question}</td>
                          <td>${r.user_answer || ''}</td>
                          <td>${r.is_correct === null ? '' : (r.is_correct ? '✅' : '❌')}</td>
                          <td>${r.correct_answer || ''}</td>
                          <td>${new Date(r.created_at).toLocaleString()}</td>
                        </tr>`;
                    });
                    tableHtml += '</tbody></table>';
                    mytriviaResults.innerHTML = tableHtml;
                }
            });
        document.getElementById('triviaForm').onsubmit = async function (e) {
            e.preventDefault();
            const amount = document.getElementById('amount').value;
            const category = document.getElementById('category').value;
            const difficulty = document.getElementById('difficulty').value;
            const type = document.getElementById('type').value;
            const params = new URLSearchParams({ amount, category, difficulty, type });
            const res = await fetch('/get-trivia?' + params.toString());
            const data = await res.json();
            document.getElementById('result').textContent = JSON.stringify(data, null, 2);

            // Save each trivia question to the database
            if (data.results && Array.isArray(data.results)) {
                for (const q of data.results) {
                    // You may want to collect user_answer and is_correct later, for now just save the question and correct_answer
                    await fetch('/save-trivia-result', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            question: q.question,
                            correct_answer: q.correct_answer,
                            user_answer: null,
                            is_correct: null
                        })
                    });
                }
            }
        };
    </script>
</body>
</html>